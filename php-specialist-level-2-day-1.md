# День - 1

## Изучение Cookie {#cookie}

Для сохранения cookie используем функцию `setcookie();`. Которая принимает семь параметров, из которых один обязательный.

#### Cookie имеет время жизни

- Временная - та которая хранится до закрытия браузера (вкладки).

- Долговременная - та, которой передан третий параметр, время хранения. Например: `time()+3600` - на один час.

#### Удаление Cookie

Отправляем запрос с "отрицательным" значением времени:

```php
setcookie("name", "John", time()-3600);
```

#### Массивы и Cookie

Так как все передаваемые запросы на сервер это строка, для пеедачи массива данных, нам необходимо произвести сериализацию (перевод массива в зашифрованную строку) и упаковать для сохранения целосности.

```php
$user = [
    'name' => 'John',
    'login' => 'root',
    'password' => '1234'
];
$str = base64_encode(serialize($user));
setcookie("user", $str);

// Получение куки
$user = unserialize(base64_decode($_COOKIE["user"]));
```

## HTTP-заголовки ответа сервера {#http-headers}

#### Переадресация ресурса

```php
// Переадресация со статусом 302
header("Location: http://mysite.local");
```

Для избегания повторной отправки данных формы методом POST, после обработки формы производим перезапрос методом GET.

_Пример:_

```php
if($_SERVER["REQUEST_METHOD"] == "POST") {
    // Форма передавала информацию
    $name = strip_tags($_POST["name"]);
    $age = $_POST["age"] * 1;

    // Сохранение в cookie
    setcookie("userName", $name);
    setcookie("userAge", $age);

    // Обработка формы
    // ...

    // Перезапрос формы методом GET
    header("Location: " . $_SERVER["PHP_SELF"]);
    exit;
}
```

Используем языковую конструкцию `exit;` для остановки выполнения скрипта. Так как страница будет переадресована и выполнение кода ниже данной переадресации не имеет смысла. Без данной конструкции ресурс будет тратиться впустую.

#### Перезапрос ресурса

```php
header("Refresh: 3");
header("Refresh: 3; url=http://mysite.local");
```

В данном случае `3` является время через которое должен произойти перезапрос (перезагрузка страницы). Вторым параметром можно указать адрес переадресации.

#### Установка типов содержимого

```php
// Принудительная установка типа передаваемого ресурса
header("Content-Type: text/xml");
// Принудительная установка кодировки передаваемого ресурса
header("Content-Type: text/html; charset=utf-8");
// Перенаправление вывода передаваемых данных
header("Content-Type: text/plain");
header("Content-Disposition: attachment filename=\"myfile.txt\"");
```

#### Управление кешированием

```php
// Запрет кэширования
header("Cache-Control: no-cache, max-age=0");
// Полный запрет кэширования
header("Cache-Control: no-store");
// Разрешение кэширования на один час относительно времени запроса
header("Cache-Control: max-age=3600");
// Разрешение кэширования на один час
header("Expires: " . date("r", time() + 3600);
```

`no-cache` - не запрещает временное кеширование.

#### Буферизация вывода

Буфер - пямять между сервером и php-скриптом. В буфер можно сохранять всё кроме заголовка.

```php
// Включаем буферизацию
ob_start();
echo 'Hello world!';
setcookie("name", "John");
// Посылаем содержимое буфера
ob_flush(); // Очищает буфер, но оставляет его открытым

echo 'Ещё контент!';
echo 'И ещё контент!'; // Эти данные попадут в буфер
// Посылаем содержимое буфера и отключаем его
ob_end_flush(); // Очищает буфер и закрываем его
```

Можно использовать буфер как глобальную переменную.

_Пример:_

```php
// Включаем буферизацию
ob_start();
echo "Hello ";
// Выбираем то, что находится в буфере. Его содержимое очищается!
$out1 = ob_get_contents();
echo "World";
// Выбираем то, что находится в буфере. Его содержимое очищается!
$out2 = ob_get_contents();
// А теперь очищаем буфер, но не закрываем
ob_clean();
echo "Саша";
echo " и ";
echo "Маша";
// Выбираем то, что находится в буфере
$out3 = ob_get_contents();
// Очищаем буфер и закрываем его
ob_end_clean();
echo $out1; // Hello
echo $out2; // Hello World
echo $out3; // Саша и Маша
```

## Использование сеансов (сессий) {#sessions}

Сессии нужны для сохранения переменных которые можно использовать в разных скриптах. В отличии от cookie, сессии хранятся на сервере, то есть пользователь не может свободно модифицировать (удалить) эти данные.
Фактически сессия, это текстовый файл на сервере, который создаётся при создании сессии. Каждый такой файл имеет название формата `sess_542834g32434gkl...` где после `sess_` уникальный идентификатор. Для идентификации клиента, ему посылается cookie с ID - php_sess_id и параметром "уникальный идентификатор".
По умолчанию время сессии до закрытия браузера.

#### Управление сеансами

```php
// Создание и(или) доступ к сессии
session_start();
// Запись в сессионную переменную
$_SESSION['name'] = 'John';
// Чтение из сессионной переменной
echo $_SESSION['name'];
// Очистка сессионных переменных
session_destroy();
// Принудительное удаление сессионной cookie
setcookie(session_name(), session_id(), time()-3600);
```

## Операции с файлами и директориями {#files-and-dirs}

#### Функция открытия потока файла

```php
// Открытие потока на чтение и получение его дескриптора
$f = fopen("file.txt", "r") or die("Не могу открыть файл!");
```

В переменную `$f` прийдёт дискриптор потока (идендификатор).

Режимы:

- r - открывает на чтение, указатель помещается в начало файла;
- r+ - чтение и запись, указатель помещается в начало файла;
- a - запись, указатель помещается в конец файла;
- a+ - чтение и запись, указатель помещается в конец файла;
- w - запись, файл обрезается до нулевой длины;
- w+ - чтение и запись, файл обрезается до нулевой длины;

##### Элеменарный парсинг

```php
// Читаем файл построчно в массив и вырезаем html-тэги, оставляя нужные
$f = fopen("file.html", "r");
$lines = [];
$lines[] = $line;
while ($line = fgetss($f, 4096, "<p><br>")) { // <p><br> - эти тэги останутся
    $lines[] = $line;
}
fclose($f);
```

#### Прямая работа с файлами

```php
// Читаем весь файл напрямую в буфер вывода
readfile("file.txt");
// Что и
$f = fopen("file.txt", "r");
echo fread($f, filesize("file.txt"));
fclose($f);

// Читаем файл построчно в массив
$lines = file("file.txt");
// Что и
$f = fopen("file.txt", "r");
while ($lines[] = fgets($f));
fclose($f);

// Получаем весь файл в виде строки
$file = file_get_contents("file.txt");
// Что и
$f = fopen("file.txt", "r");
$file = fread($f, filesize("file.txt"));
fclose($f);

// Пишем в файл добавляя содержимое в конец
file_put_contents("file.txt", "Новое содержимое", FILE_APPEND);
// Что и
$f = fopen("file.txt", "a");
fputs($f, "Новое содержимое");
fclose($f);
```